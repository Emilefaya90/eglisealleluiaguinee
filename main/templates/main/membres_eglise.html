{% extends "main/base.html" %}
{% load i18n static %}

{% block title %}Membres d'Église — Gestion Église{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-people me-2"></i>Membres d'Église</h5>
          <div class="d-flex gap-2">
            <a href="{% url 'main:accueil' %}" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-house"></i> Accueil
            </a>
            <a href="{% url 'main:nos_fideles' %}" class="btn btn-primary btn-sm">
              <i class="bi bi-ui-checks-grid"></i> Aller à "Nos Fidèles"
            </a>
          </div>
        </div>
        <div class="card-body">
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #5b8cff, #2b4aa3); color: #fff;">
          <span class="fw-semibold d-flex align-items-center">
            <i class="bi bi-list-ul me-2"></i>Liste complète des adhérents
            <span class="ms-2 d-inline-flex align-items-center gap-1">
              <span class="badge bg-light text-dark">Total: <span id="membersTotal">0</span></span>
              <span class="badge bg-warning text-dark">Affichés: <span id="membersShown">0</span></span>
            </span>
          </span>
          <div class="d-none" id="filters-placeholder"></div>
        </div>
        <!-- Les Filtres: barre dédiée -->
        <div class="border-bottom" style="background: linear-gradient(135deg, #5b8cff, #2b4aa3);">
          <div class="d-flex align-items-center gap-2 flex-nowrap px-3 py-2 text-white" style="overflow:auto; white-space:nowrap;">
            <span class="fw-semibold small me-2"><i class="bi bi-funnel me-1"></i>Les Filtres</span>
            <div class="d-flex align-items-center">
              <label for="egliseFilter" class="me-2 mb-0 small text-white-50">Église:</label>
              <select id="egliseFilter" class="form-select form-select-sm" style="min-width: 220px;">
                <option value="">Toutes les Églises</option>
                {% for e in eglises %}
                  <option value="{{ e.nom|escape }}">{{ e.nom }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="d-flex align-items-center">
              <label for="departementFilter" class="ms-2 me-2 mb-0 small text-white-50">Département:</label>
              <select id="departementFilter" class="form-select form-select-sm" style="min-width: 220px;">
                <option value="">Tous</option>
              </select>
            </div>
            <div class="d-flex align-items-center">
              <label for="soutienFilter" class="ms-2 me-2 mb-0 small text-white-50">Soutien:</label>
              <select id="soutienFilter" class="form-select form-select-sm" style="min-width: 140px;">
                <option value="">Tous</option>
                <option value="Oui">Oui</option>
                <option value="Non">Non</option>
              </select>
            </div>
            <div class="d-flex align-items-center">
              <label for="dateFrom" class="ms-2 me-2 mb-0 small text-white-50">Du:</label>
              <input id="dateFrom" type="date" class="form-control form-control-sm" style="min-width: 150px;" />
            </div>
            <div class="d-flex align-items-center">
              <label for="dateTo" class="ms-2 me-2 mb-0 small text-white-50">Au:</label>
              <input id="dateTo" type="date" class="form-control form-control-sm" style="min-width: 150px;" />
            </div>
            <button id="resetFilters" class="btn btn-outline-light btn-sm ms-2"><i class="bi bi-x-circle me-1"></i>Réinitialiser</button>
            <button id="exportExcel" class="btn btn-success btn-sm"><i class="bi bi-file-earmark-excel me-1"></i>Excel</button>
            <button id="exportPDF" class="btn btn-danger btn-sm"><i class="bi bi-file-earmark-pdf me-1"></i>PDF</button>
            <button id="printTable" class="btn btn-primary btn-sm"><i class="bi bi-printer me-1"></i>Imprimer</button>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table id="fullMembersTable" class="table table-sm table-striped table-hover align-middle" style="width:100%">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Nom complet</th>
                  <th>Sexe</th>
                  <th>Naissance</th>
                  <th>Contact</th>
                  <th>Église</th>
                  <th>Baptême</th>
                  <th class="ellipsis">Motivation</th>
                  <th class="ellipsis">Services</th>
                  <th>Département</th>
                  <th>Soutien</th>
                  <th><i class="bi bi-cash-coin me-1"></i>Montant</th>
                  <th><i class="bi bi-folder2-open me-1"></i>Docs</th>
                  <th>Date</th>
                  <th class="no-export">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="confirmDeleteMembreModal" tabindex="-1" aria-labelledby="confirmDeleteMembreLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteMembreLabel"><i class="bi bi-exclamation-triangle text-danger me-2"></i>Confirmer la suppression</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Cette action est irréversible. Confirmez-vous la suppression définitive du membre <strong id="deleteMembreName"></strong> ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteMembreBtn">Supprimer définitivement</button>
      </div>
    </div>
  </div>
  
</div>
{% endblock %}

{% block extra_js %}
  <!-- DataTables & Buttons -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

  <script>
    (function(){
      function truncateText(str, max){
        const s = (str || '').toString();
        return s.length > max ? s.slice(0, max - 1) + '…' : s;
      }
      function formatMontant(val){
        if(val === null || val === undefined || val === '') return '';
        const n = Number(val);
        if(Number.isNaN(n)) return val.toString();
        return new Intl.NumberFormat('fr-FR').format(n);
      }
      function formatMontantGNF(val){
        const f = formatMontant(val);
        return f ? `${f} GNF` : '';
      }
      function formatBytes(bytes){
        const b = Number(bytes);
        if(!b || isNaN(b)) return '';
        const u = ['octets','Ko','Mo','Go','To'];
        const i = Math.floor(Math.log(b)/Math.log(1024));
        const v = (b/Math.pow(1024,i)).toFixed(i===0?0:1);
        return `${v} ${u[i]}`;
      }
      function docIcon(url){
        const u = (url || '').toLowerCase();
        if(u.endsWith('.pdf')) return 'bi-file-earmark-pdf';
        if(/\.(png|jpe?g|gif|webp|bmp|tiff?|heic|heif)$/.test(u)) return 'bi-image';
        return 'bi-file-earmark';
      }
      function initDocPopovers(){
        if (window.bootstrap && document.querySelector('[data-doc-preview="img"]')){
          document.querySelectorAll('[data-doc-preview="img"]').forEach(el => {
            if(el._docPopoverInitialized) return;
            const url = el.getAttribute('data-doc-url');
            new bootstrap.Popover(el, {
              trigger: 'hover focus', placement: 'top', html: true, sanitize: false,
              content: `<img src="${url}" alt="preview" style="max-width:200px; max-height:160px; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,.2);"/>`
            });
            el._docPopoverInitialized = true;
          });
        }
      }

      let rowCounter = 0;
      const dt = new DataTable('#fullMembersTable', {
        paging: true,
        pagingType: 'numbers',
        pageLength: 50,
        searching: true,
        responsive: true,
        autoWidth: true,
        scrollX: true,
        deferRender: true,
        ordering: false,
        columnDefs: [
          { targets: '_all', className: 'text-nowrap' },
          { targets: [7,8], className: 'ellipsis' },
          { targets: [2,6,10,12,13,14], className: 'text-center' },
          { targets: [11], className: 'text-end' }
        ],
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json'
        }
      });

      // Ajouter les boutons Buttons à DataTable (cachés, déclenchés par nos boutons custom)
      new $.fn.dataTable.Buttons(dt, {
        buttons: [
          { extend: 'excelHtml5', title: 'Membres', text: 'Excel', exportOptions: { columns: ':visible:not(.no-export)' } },
          { extend: 'pdfHtml5', title: 'Membres', text: 'PDF', orientation: 'landscape', pageSize: 'A4', exportOptions: { columns: ':visible:not(.no-export)' } },
          { extend: 'print', title: 'Membres', text: 'Imprimer', exportOptions: { columns: ':visible:not(.no-export)' } }
        ]
      });
      dt.buttons(0, null).container().hide();

      document.getElementById('exportExcel').addEventListener('click', function(){ dt.button?.('0').trigger(); });
      document.getElementById('exportPDF').addEventListener('click', function(){ dt.button?.('1').trigger(); });
      document.getElementById('printTable').addEventListener('click', function(){ dt.button?.('2').trigger(); });

      // Charger toutes les données depuis l'API
      (async function loadAll(){
        try{
          const resp = await fetch('/api/membres/');
          const json = await resp.json();
          if(json && json.success && Array.isArray(json.membres)){
            const uniqueDepts = new Set();
            for(const m of json.membres){
              rowCounter += 1;
              const nomComplet = `${m.prenom || ''} ${m.nom || ''}`.trim();
              const sexeDisp = m.sexe === 'M' ? 'Masculin' : (m.sexe === 'F' ? 'Féminin' : (m.sexe || ''));
              const naissance = `${m.date_naissance || ''}${m.lieu_naissance ? ' • ' + m.lieu_naissance : ''}`;
              const contact = `${m.telephone || ''}${m.email ? ' / ' + m.email : ''}`;
              // Église: supporter plusieurs formats (string, clés alternatives, ou objet)
              let egliseNom = '';
              const egliseCandidates = [
                m.eglise_nom,
                m.egliseName,
                m.eglise_name,
                m.egliseNom,
                (typeof m.eglise === 'string' ? m.eglise : null)
              ];
              for (const c of egliseCandidates){
                if (typeof c === 'string' && c.trim()) { egliseNom = c.trim(); break; }
              }
              if (!egliseNom && m.eglise && typeof m.eglise === 'object'){
                egliseNom = (m.eglise.nom || m.eglise.name || '').toString().trim();
              }
              if (!egliseNom && typeof m.eglise === 'number'){
                egliseNom = String(m.eglise);
              }
              if (!egliseNom && typeof m.eglise_id === 'number'){
                egliseNom = String(m.eglise_id);
              }
              if (!egliseNom) { egliseNom = '—'; }
              const bap = m.date_bapteme ? `Oui (-, ${m.lieu_bapteme || '-'}, ${m.date_bapteme || '-'})` : 'Non';
              const motivationFull = (m.motivation || '').toString();
              const servicesFull = (m.services || '').toString();
              const motivation = `<span title="${motivationFull.replaceAll('"','&quot;')}">${truncateText(motivationFull, 60)}</span>`;
              const services = `<span title="${servicesFull.replaceAll('"','&quot;')}">${truncateText(servicesFull, 60)}</span>`;
              const soutien = m.soutien_financier ? 'Oui' : 'Non';
              const montant = formatMontantGNF(m.montant_souhaite || '');
              // Documents: pièce d'identité et certificat de baptême si présents
              const pi = m.piece_identite_url || m.piece_identite || '';
              const cb = m.certificat_bapteme_url || m.certificat_bapteme || '';
              const piSize = m.piece_identite_size; const cbSize = m.certificat_bapteme_size;
              let docsHtml = '';
              const link = (url, label, size) => {
                const icon = docIcon(url);
                const isImg = icon === 'bi-image';
                const sizeTxt = size ? ` (${formatBytes(size)})` : '';
                const attrs = isImg ? `data-doc-preview="img" data-doc-url="${url}"` : '';
                return `<a href="${url}" target="_blank" ${attrs} class="badge bg-info text-decoration-none me-1"><i class="bi ${icon} me-1"></i>${label}${sizeTxt}</a>`;
              };
              if (pi) docsHtml += link(pi, 'Pièce', piSize);
              if (cb) docsHtml += link(cb, 'Baptême', cbSize);
              if (!docsHtml) docsHtml = '<span class="badge bg-secondary">Aucun</span>';
              const date = m.date_adhesion || '';
              // Départements: accepter string/CSV/array, objets ou tableaux d'objets; afficher en badges; alimenter le filtre
              const deptCandidates = [
                m.departement,
                m.departement_nom,
                m.departement_name,
                m.departementNom,
                m.departements,
                m.departments,
                m.depts,
                m.departement_labels,
                m.departements_noms
              ];
              let rawDept = '';
              for (const c of deptCandidates){
                if (c !== undefined && c !== null && c !== '') { rawDept = c; break; }
              }
              let deptItems = [];
              const pickLabel = (obj) => (obj && (obj.nom || obj.name || obj.libelle || obj.libelle_long || obj.label)) ? (obj.nom || obj.name || obj.libelle || obj.libelle_long || obj.label) : '';
              if (Array.isArray(rawDept)){
                // tableau de strings et/ou d'objets
                deptItems = rawDept.map(x => {
                  if (typeof x === 'string') return x.trim();
                  if (typeof x === 'object') return pickLabel(x).toString().trim();
                  if (typeof x === 'number') return String(x);
                  return '';
                }).filter(Boolean);
              } else if (typeof rawDept === 'object') {
                // objet unique
                const lbl = pickLabel(rawDept).toString().trim();
                if (lbl) deptItems = [lbl];
              } else if (typeof rawDept === 'number') {
                deptItems = [String(rawDept)];
              } else {
                // string ou vide -> CSV possible
                const s = (rawDept || '').toString();
                deptItems = s.includes(',') ? s.split(',').map(x => x.trim()).filter(Boolean) : [s.trim()].filter(Boolean);
              }
              // Nettoyage doublons et tri stable d'affichage
              const cleanDepts = Array.from(new Set(deptItems.filter(Boolean)));
              cleanDepts.forEach(d => uniqueDepts.add(d));
              const deptText = cleanDepts.join(', ');
              const deptHtml = cleanDepts.length ? cleanDepts.map(d => `<span class="badge bg-secondary me-1">${d}</span>`).join('') : '<span class="badge bg-secondary">Aucun</span>';
              const id = m.id;
              const actions = `
                <div class="btn-group" role="group" aria-label="Actions">
                  <a class="btn btn-sm btn-outline-primary" href="/membres-eglise/modifier/${id}/" title="Modifier">
                    <i class="bi bi-pencil-square"></i>
                  </a>
                  <a class="btn btn-sm btn-outline-info" href="/membres-eglise/details/${id}/" title="Détails">
                    <i class="bi bi-info-circle"></i>
                  </a>
                  <button type="button" class="btn btn-sm btn-outline-danger btn-delete-membre" data-id="${id}" data-name="${(nomComplet || '').replaceAll('"','&quot;')}">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>`;
              dt.row.add([
                rowCounter,
                nomComplet,
                sexeDisp,
                naissance,
                contact,
                egliseNom,
                bap,
                motivation,
                services,
                deptHtml,
                soutien,
                montant,
                docsHtml,
                date,
                actions
              ]);
            }
            dt.draw(false);
            initDocPopovers();
            updateCounts();

            // Remplir le filtre Département avec les valeurs distinctes
            const deptSel = document.getElementById('departementFilter');
            if(deptSel && uniqueDepts.size){
              const opts = Array.from(uniqueDepts).sort((a,b)=>a.localeCompare(b, 'fr'));
              opts.forEach(v=>{
                const opt = document.createElement('option');
                opt.value = v; opt.textContent = v; deptSel.appendChild(opt);
              });
            }
            // Mettre à jour les compteurs après le chargement
            updateCounts();
          }
        }catch(err){
          console.error('Erreur chargement membres:', err);
          // En cas d'erreur, afficher 0
          const totalBadge = document.getElementById('membersTotal');
          const shownBadge = document.getElementById('membersShown');
          if(totalBadge) totalBadge.textContent = '0';
          if(shownBadge) shownBadge.textContent = '0';
        }
      })();

      // Ajustements UI
      setTimeout(()=>{ dt.columns.adjust(); if(dt.responsive?.recalc) dt.responsive.recalc(); }, 100);
      window.addEventListener('resize', ()=>{ dt.columns.adjust(); if(dt.responsive?.recalc) dt.responsive.recalc(); });

      // Compteurs: Total / Affichés
      function updateCounts(){
        try{
          if(!dt || !dt.rows) return;
          const totalEl = document.getElementById('membersTotal');
          const shownEl = document.getElementById('membersShown');
          const total = dt.rows().count();
          const shown = dt.rows({ search: 'applied' }).count();
          if(totalEl) totalEl.textContent = total;
          if(shownEl) shownEl.textContent = shown;
        }catch(e){ /* noop */ }
      }
      if (dt && dt.on) dt.on('draw', updateCounts);

      

      // Filtre Église (colonne cachée index 5)
      const egliseFilter = document.getElementById('egliseFilter');
      if(egliseFilter){
        egliseFilter.addEventListener('change', function(){
          const val = this.value;
          if(!val){ dt.column(5).search('').draw(); return; }
          const pattern = '^' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '$';
          dt.column(5).search(pattern, true, false).draw();
        });
      }

      // Filtre Département (colonne index 9)
      const departementFilter = document.getElementById('departementFilter');
      if(departementFilter){
        departementFilter.addEventListener('change', function(){
          const val = this.value;
          if(!val){ dt.column(9).search('').draw(); return; }
          // recherche par inclusion pour supporter plusieurs départements par ligne
          dt.column(9).search(val, false, false).draw();
        });
      }

      // Filtre Soutien (colonne index 10)
      const soutienFilter = document.getElementById('soutienFilter');
      if(soutienFilter){
        soutienFilter.addEventListener('change', function(){
          const val = this.value;
          if(!val){ dt.column(10).search('').draw(); return; }
          const pattern = '^' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '$';
          dt.column(10).search(pattern, true, false).draw();
        });
      }

      // Réinitialiser tous les filtres
      const resetBtn = document.getElementById('resetFilters');
      if(resetBtn){
        resetBtn.addEventListener('click', function(){
          if(egliseFilter) egliseFilter.value = '';
          if(departementFilter) departementFilter.value = '';
          if(soutienFilter) soutienFilter.value = '';
          if(dateFrom) dateFrom.value = '';
          if(dateTo) dateTo.value = '';
          dt.search('');
          dt.column(5).search('');
          dt.column(9).search('');
          dt.column(10).search('');
          dt.draw();
        });
      }
      

      // Filtre par période (Date d'adhésion) - colonne index 13
      const dateFrom = document.getElementById('dateFrom');
      const dateTo = document.getElementById('dateTo');
      if ($.fn && $.fn.dataTable && $.fn.dataTable.ext) {
        $.fn.dataTable.ext.search.push(function(settings, data){
          // S'applique uniquement à ce tableau
          const tableId = settings.nTable ? settings.nTable.getAttribute('id') : '';
          if (tableId !== 'fullMembersTable') return true;

          // data[13] = Date (format ISO YYYY-MM-DD)
          const rowDate = (data[13] || '').trim();
          const fromVal = (dateFrom && dateFrom.value) ? dateFrom.value : '';
          const toVal = (dateTo && dateTo.value) ? dateTo.value : '';

          // Si aucun filtre défini, ne pas filtrer
          if (!fromVal && !toVal) return true;

          // Si la ligne n'a pas de date, l'exclure lorsque la plage est définie
          if (!rowDate) return false;

          // Comparaison lexicographique suffisante pour YYYY-MM-DD
          if (fromVal && rowDate < fromVal) return false;
          if (toVal && rowDate > toVal) return false;
          return true;
        });
      }

      if (dateFrom) dateFrom.addEventListener('change', ()=> dt.draw());
      if (dateTo) dateTo.addEventListener('change', ()=> dt.draw());

      // --- Suppression d'un membre via POST sécurisé (AJAX) ---
      // Récupère le token CSRF depuis le cookie
      function getCookie(name){
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if(parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }

      let deleteTarget = { id: null, rowNode: null, name: '' };
      const tableEl = document.getElementById('fullMembersTable');
      const confirmBtn = document.getElementById('confirmDeleteMembreBtn');
      const nameSpan = document.getElementById('deleteMembreName');
      const modalEl = document.getElementById('confirmDeleteMembreModal');
      let bsModal = null;
      if (modalEl && window.bootstrap) {
        bsModal = new bootstrap.Modal(modalEl);
      }

      if (tableEl) {
        tableEl.addEventListener('click', function(e){
          const btn = e.target.closest('.btn-delete-membre');
          if(!btn) return;
          e.preventDefault();
          deleteTarget.id = btn.getAttribute('data-id');
          deleteTarget.name = btn.getAttribute('data-name') || '';
          deleteTarget.rowNode = btn.closest('tr');
          if (nameSpan) nameSpan.textContent = deleteTarget.name || deleteTarget.id;
          if (bsModal) bsModal.show();
        });
      }

      if (confirmBtn) {
        confirmBtn.addEventListener('click', async function(){
          if(!deleteTarget.id) return;
          try{
            const resp = await fetch(`/membres-eglise/supprimer/${deleteTarget.id}/`, {
              method: 'POST',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken') || ''
              }
            });
            const json = await resp.json().catch(()=>({ success:false, error:'Réponse invalide' }));
            if (json && json.success){
              if (bsModal) bsModal.hide();
              if (deleteTarget.rowNode) {
                dt.row(deleteTarget.rowNode).remove();
                dt.draw(false);
                updateCounts();
              }
            } else {
              alert((json && json.error) ? `Erreur: ${json.error}` : 'La suppression a échoué.');
            }
          }catch(err){
            alert('Erreur lors de la suppression.');
            console.error(err);
          }finally{
            deleteTarget = { id: null, rowNode: null, name: '' };
          }
        });
      }
    })();
  </script>
{% endblock %}

